#!/bin/sh -ex

apt-get update
apt-get -y install jellyfin jellyfin-ffmpeg

# Rename the file server for WebDAVCGI
CONF=/var/www/webdavcgi/webdav.conf
sed -i "s|FILESERVER|MEDIASERVER|" $CONF

# Rename the samba service
CONF=/etc/samba/smb.conf
sed -i "s|FILESERVER|MEDIASERVER|" $CONF
sed -i "s|FileServer|MediaServer|" $CONF

# Change default group to users
usermod -g users jellyfin

# Setup default media directories
for fn in Music Movies TVShows Photos; do
    mkdir -p /srv/storage/$fn
    chown jellyfin:users /srv/storage/$fn
    chmod g+w /srv/storage/$fn
done

# TurnKey credit on Login page
mv /usr/local/src/jellyfin-branding.xml /etc/jellyfin/branding.xml

# Apache config for WebDavCGI
a2dissite 000-default.conf
a2ensite webdavcgi.conf
a2ensite tkl-webcp.conf

# dirty hack to allow jellyfin to run in a chroot
mkdir -p /sys/class/net/eth0
mkdir -p /sys/class/net/lo
echo 1500 > /sys/class/net/eth0/mtu
echo 65536 > /sys/class/net/lo/mtu

. /etc/default/jellyfin

export JELLYFIN_DATA_DIR JELLYFIN_CONFIG_DIR JELLYFIN_LOG_DIR JELLYFIN_CACHE_DIR

JELLYFIN_LOG_FILE=/var/log/jellyfin/jellyfin_log

su -s /bin/bash jellyfin -c "/usr/bin/jellyfin \
    ${JELLYFIN_WEB_OPT} ${JELLYFIN_RESTART_OPT} \
    ${JELLYFIN_FFMPEG_OPT} ${JELLYFIN_SERVICE_OPT} \
    ${JELLYFIN_NOWEBAPP_OPT}" > $JELLYFIN_LOG_FILE&

until grep 'Startup complete' $JELLYFIN_LOG_FILE
do
    sleep 2
done
pid=$(pgrep jellyfin)

sleep 2

curl 'http://localhost:8096/Startup/Configuration' --data-raw 'UICulture=en-US&MetadataCountryCode=US&PreferredMetadataLanguage=en'
curl 'http://localhost:8096/Startup/User'
curl 'http://localhost:8096/Startup/User' --data-raw 'Name=jellyfin&Password=test'
curl 'http://localhost:8096/Startup/Configuration' --data-raw 'UICulture=en-US&MetadataCountryCode=US&PreferredMetadataLanguage=en'
curl 'http://localhost:8096/Startup/RemoteAccess' --data-raw 'EnableRemoteAccess=true&EnableAutomaticPortMapping=false'
curl 'http://localhost:8096/Startup/Complete' --data-raw ''
until grep 'Scan Media Library Completed' $JELLYFIN_LOG_FILE
do
    sleep 2
done

kill $pid
while kill -0 $pid; do
    sleep 1
done
chown -R jellyfin:adm /var/lib/jellyfin
rm -r /sys/*

# Apache config for reverse proxy
echo 'Listen 12322' >> /etc/apache2/ports.conf
a2ensite jellyfin-proxy.conf
a2enmod headers
a2enmod proxy_http
a2enmod proxy_wstunnel
